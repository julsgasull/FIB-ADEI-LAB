---
title: "Deliverable 1"
author: "juls&claudia"
date: \today
output:
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
  html_document:
    toc: no
    toc_depth: '4'
  word_document:
    toc: no
    toc_depth: '4'
geometry: left=1.9cm,right=1.9cm,top=1.25cm,bottom=1.52cm
fontsize: 18pt
subtitle: Data Processing, Description, Validation and Profiling
classoption: a4paper
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data description
* Description http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml
* Data Dictionary - SHL Trip Records -This data dictionary describes SHL trip data in visit http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml:

## Variables
* VendorID
  * A code indicating the LPEP provider that provided the record.     
  * Values: 
    * 1= Creative Mobile Technologies, LLC
    * 2= VeriFone Inc.   
* lpep_pickup_datetime	
  * The date and time when the meter was engaged.    
* lpep_dropoff_datetime	
  * The date and time when the meter was disengaged.     
* Passenger_count	
  * The number of passengers in the vehicle. 
  * This is a driver-entered value.    
* Trip_distance
  * The elapsed trip distance in miles reported by the taximeter.   
* Pickup_longitude
  * Longitude where the meter was engaged.   
* Pickup_latitude
  * Latitude where the meter was engaged.   
* RateCodeID
  * The final rate code in effect at the end of the trip.
  * Values: 
      * 1=Standard rate  
      * 2=JFK 
      * 3=Newark 
      * 4=Nassau or Westchester 
      * 5=Negotiated fare 
      * 6=Group ride   
* Store_and_fwd_flag	
  * This flag indicates whether the trip record was held in vehicle memory before sending to the vendor, aka "store and forward," because the vehicle did not have a connection to the server: 
  * Values
    * Y= store and forward trip  
    * N= not a store and forward trip   
* Dropoff_longitude	
  * Longitude where the meter was timed off.   
* Dropoff_latitude	
  * Latitude where the meter was timed off.   
* Payment_type
  * A numeric code signifying how the passenger paid for the trip.
  * Values:
    * 1= Credit card 
    * 2= Cash 
    * 3= No charge 
    * 4= Dispute 
* Fare_amount	
  * The time-and-distance fare calculated by the meter.   
* Extra	 
  * Miscellaneous extras and surcharges.  
  * Currently, this only includes the $0.50 and $1 rush hour and overnight charges. 
* MTA_tax	 
  * $0.50 MTA tax that is automatically triggered based on the metered rate in use.   
* Improvement_surcharge	
  * $0.30 improvement surcharge assessed on hailed trips at the flag   drop. 
  * The improvement surcharge began being levied in 2015.   
* Tip_amount
  * This field is automatically populated for credit card tips. 
  * Cash tips are not included.   
* Tolls_amount	
  * Total amount of all tolls paid in trip.    
* Total_amount	
  * The total amount charged to passengers. 
  * Does not include cash tips.   
* Trip_type	
  * A code indicating whether the trip was a street-hail or a dispatch that is automatically assigned based on the metered rate in use but can be altered by the driver. 
  * Values:
    * 1= Street-hail 
    * 2= Dispatch  
    
# Load Required Packages for this deliverable
We load the necessary packages and set working directory
```{r}
setwd("~/Documents/uni/FIB-ADEI-LAB/deliverable1")

# Load Required Packages
options(contrasts=c("contr.treatment","contr.treatment"))

requiredPackages <- c("missMDA","chemometrics","mvoutlier","effects","FactoMineR","car", "factoextra","RColorBrewer","dplyr","ggmap","ggthemes","knitr")
missingPackages <- requiredPackages[!(requiredPackages %in% installed.packages()[,"Package"])]

if(length(missingPackages)) install.packages(missingPackages)
lapply(requiredPackages, require, character.only = TRUE)

```

## Select a sample of 5000 records
From the proposed database, we need to select a sample of 5000 records randomly so we can start analyzing our data.

```{r}
if(!is.null(dev.list())) dev.off()  # Clear plots
rm(list=ls())                       # Clean workspace

# green_tripdata_2016-01
setwd("~/Documents/uni/FIB-ADEI-LAB/deliverable1")
filepath<-"~/Documents/uni/FIB-ADEI-LAB/deliverable1"

df<-read.table(paste0(filepath,"/green_tripdata_2016-01.csv"),header=T, sep=",")
dim(df)       # Displays the sample size
names(df)     # Displays the names of the sample variables
summary(df)   

# Select your 5000 register sample (random sample)
# Use birthday of 1 member of the group --> Júlia's one

set.seed(180998)
sam<-as.vector(sort(sample(1:nrow(df),5000)))

# Verification and storage of the sample
head(df)
df<-df[sam,]
summary(df)
save.image("Taxi5000_raw.RData")
```

## Some useful functions

```{r, echo=FALSE}

# Some useful functions
calcQ <- function(x) {
  s.x <- summary(x)
  iqr<-s.x[5]-s.x[2]
  list(souti=s.x[2]-3*iqr, mouti=s.x[2]-1.5*iqr, min=s.x[1], q1=s.x[2], q2=s.x[3], 
       q3=s.x[5], max=s.x[6], mouts=s.x[5]+1.5*iqr, souts=s.x[5]+3*iqr ) }

countNA <- function(x) {
  mis_x <- NULL
  for (j in 1:ncol(x)) {mis_x[j] <- sum(is.na(x[,j])) }
  mis_x <- as.data.frame(mis_x)
  rownames(mis_x) <- names(x)
  mis_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {mis_i <- mis_i + as.numeric(is.na(x[,j])) }
  list(mis_col=mis_x,mis_ind=mis_i) }

countX <- function(x,X) {
  n_x <- NULL
  for (j in 1:ncol(x)) {n_x[j] <- sum(x[,j]==X) }
  n_x <- as.data.frame(n_x)
  rownames(n_x) <- names(x)
  nx_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {nx_i <- nx_i + as.numeric(x[,j]==X) }
  list(nx_col=n_x,nx_ind=nx_i) }

```

--------------------------------------------------------------------------------

# Initialization of counts for missings, outliers and errors. All numerical variables have to be checked before

```{r}
imis<-rep(0,nrow(df))  # rows - trips
jmis<-rep(0,2*ncol(df))  # columns - variables

mis1<-countNA(df)
imis<-mis1$mis_ind
mis1$mis_col # Number of missings for the current set of variables

iouts<-rep(0,nrow(df))  # rows - trips
jouts<-rep(0,2*ncol(df))  # columns - variables

ierrs<-rep(0,nrow(df))  # rows - trips
jerrs<-rep(0,2*ncol(df))  # columns - variables
```

# Univariate Descriptive Analysis

## Qualitative Variables (Factors) / Categorical
Description: Original numeric variables corresponding to qualitative concepts have to be converted to factors. New factors grouping original levels will be considered very positively.

We need to do an analysis of all the variables to be able to identify missings, errors and outliers. We will also try to factorize each variable to make it easier to understand the sample.

```{r}
summary(df)
names(df)
```

### 1. VendorID
```{r}
df$VendorID<-factor(df$VendorID,labels=c("Mobile","VeriFone"))
nlevels(df$VendorID)
levels(df$VendorID)<-paste0("f.Vendor-",levels(df$VendorID))

barplot(summary(df$VendorID),main="VendorID Barplot",col = "DarkOrchid")
# With the "factor" command what we are doing is factorizing the variable we pass to it and the value that comes out with the "levels" is the total number of our 5000 observations that each type of VendorID has and as we can see all the factors have value and we have no NA (data missing)
```

### 8. RateCodeID
```{r}
summary(df$RateCodeID)
df$RateCodeID<-factor(df$RateCodeID)
barplot(summary(df$RateCodeID),main="RateCodeID Barplot",col = "DarkOrchid")

# We see that most samples are in RateCodeID = 1, which is what we are interested in. Therefore, we factorize and create only two groups, the one with RateCodeID = 1 and the rest.

df$f.Rate<-1  # rep(1,nrow(df))
ll<-which(df$RateCodeID != "1");length(ll)
df$f.Rate[ll]<-2
df$f.Rate<-factor(df$f.Rate,levels=1:2,labels=c("f.Rate-1","f.Rate-Other"))
barplot(summary(df$f.Rate),main="RateCodeID Barplot",col = "DarkOrchid")
# He is now more balanced.
```

### 9. Store_and_fwd_flag
```{r}
summary(df$Store_and_fwd_flag)
df$Store_and_fwd_flag<-factor(df$Store_and_fwd_flag)
```

### 12. Payment_type
```{r}
df$Payment_type<-factor(df$Payment_type,labels=c("Credit card","Cash","No charge","Dispute"))
summary(df$Payment_type)
barplot(summary(df$Payment_type),main="Payment_type Barplot",col = "DarkOrchid")

???????????????
```



## Original numeric variables corresponding to real quantitative concepts are kept as numeric but additional factors should also be created as a discretization of each numeric variable.

### 2. lpep_pickup_datetime
```{r}
## I just keep the hours
df$pickup<-substr(strptime(df$lpep_pickup_datetime, "%Y-%m-%d %H:%M:%S"), 12, 13)
```

### 3. lpep_dropoff_datetime
```{r}
## I just keep the hours
df$dropoff<-substr(strptime(df$Lpep_dropoff_datetime, "%Y-%m-%d %H:%M:%S"), 12, 13)
```

### 4. Passenger_count
```{r}
summary(df$Passenger_count)
df[which(df[,"Passenger_count"]==0),]

sel<-which(df$Passenger_count ==0)
ierrs[sel]<-ierrs[sel]+1
names(df)
jerrs[10]<-length(sel)
sel                 
#### sel contains the rownames of the individuals with "0" as  value for longitude
df[sel,"Passenger_count"]<-NA    
# non-possible values are replaced by NA, missing value symbol in R
```

### 5. Trip_distance
```{r}
summary(df$Trip_distance)
df[which(df[,"Trip_distance"]==0),]

# Outlier detection
Boxplot(df$Trip_distance)
var_out<-calcQ(df$Trip_distance)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")
abline(h=30,col="blue",lwd=2)

llout<-which((df$Trip_distance<0)|(df$Trip_distance>30))
iouts[llout]<-iouts[llout]+1
jouts[11]<-length(llout)
df[llout,"Trip_distance"]<-NA 
sel
```

### 6. Pickup_longitude
```{r}
summary(df$Pickup_longitude)
# 0.00 looks to be an error
# Seeing the individuals with this "0" value:
df[which(df[,"Pickup_longitude"]==0),]

# It is a quantitive variable  Non-possible values will be recoded to NA
sel<-which(df$Pickup_longitude ==0)
ierrs[sel]<-ierrs[sel]+1
names(df)
jerrs[6]<-length(sel)
sel                 
#### sel contains the rownames of the individuals with "0" as value for longitude
df[sel,"Pickup_longitude"]<-NA    # non-possible values are replaced by NA, missing value symbol in R

##### Which trips are not running in New-York?
# Consider if, at least, one of the pick-up and drop-off points belong to New-York area. If not, this trip is an "out-of-scope" individual and has to be eliminated of the basis. Nevertheless, you have to justify this elimimation and count how many individuals were in this situation
# Look at that!! Possibly, starting from the outliers... "0" is missing value, outliers can help to detect trips running outside of New York...
```

### 7. Pickup_latitude
```{r}
summary(df$Pickup_latitude)
# 0.00 looks to be an error
# Seeing the individuals with this "0" value:
df[which(df[,"Pickup_latitude"]==0),]

# It is a quantitive variable  Non-possible values will be recoded to NA
sel<-which(df$Pickup_latitude ==0)
ierrs[sel]<-ierrs[sel]+1
names(df)
jerrs[7]<-length(sel)
sel 
#### sel contains the rownames of the individuals with "0" as  value for longitude
df[sel,"Pickup_latitude"]<-NA    
# non-possible values are replaced by NA, missing value symbol in R
```
### 10. Dropoff_longitude
```{r}
summary(df$Dropoff_longitude)
# 0.00 looks to be an error
# Seeing the individuals with this "0" value:
df[which(df[,"Dropoff_longitude"]==0),]

# It is a quantitive variable  Non-possible values will be recoded to NA
sel<-which(df$Dropoff_longitude ==0)
ierrs[sel]<-ierrs[sel]+1
names(df)
jerrs[8]<-length(sel)
sel                 
#### sel contains the rownames of the individuals with "0" as  value for longitude
df[sel,"Dropoff_longitude"]<-NA    
# non-possible values are replaced by NA, missing value symbol in R
```

### 11. Dropoff_latitude
```{r}
summary(df$Dropoff_latitude)
# 0.00 looks to be an error
# Seeing the individuals with this "0" value:
df[which(df[,"Dropoff_latitude"]==0),]

# It is a quantitive variable  Non-possible values will be recoded to NA
sel<-which(df$Dropoff_latitude ==0)
ierrs[sel]<-ierrs[sel]+1
names(df)
jerrs[9]<-length(sel)
sel                
#### sel contains the rownames of the individuals with "0" as  value for longitude
df[sel,"Dropoff_latitude"]<-NA    
# non-possible values are replaced by NA, missing value symbol in R
```

### 13. Fare_amount
```{r}
summary(df$Fare_amount)
df[which(df[,"Fare_amount"]<0),]

# Outlier detection
Boxplot(df$Fare_amount)
var_out<-calcQ(df$Fare_amount)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")
abline(h=120,col="blue",lwd=2)

llout<-which((df$Fare_amount<0)|(df$Fare_amount>120))
iouts[llout]<-iouts[llout]+1
jouts[12]<-length(llout)
df[llout,"Fare_amount"]<-NA 
sel
```

### 14. Extra
```{r}
summary(df$Extra)
df[which(df[, "Extra"] < 0),]

sel<-which(df$Extra < 0)
ierrs[sel]<-ierrs[sel]+1
names(df)
jerrs[13]<-length(sel)
df[sel,"Extra"]<-NA 
sel
```

### 15. MTA_tax
```{r}
summary(df$MTA_tax)
df[which(df[, "MTA_tax"] < 0),]

sel<-which(df$MTA_tax < 0)
ierrs[sel]<-ierrs[sel]+1
names(df)
jerrs[14]<-length(sel)
df[sel,"MTA_tax"]<-NA 
sel
```

### 16. Improvement_surcharge
```{r}
summary(df$improvement_surcharge)
df[which(df[, "improvement_surcharge"] < 0),]

sel<-which(df$improvement_surcharge < 0)
ierrs[sel]<-ierrs[sel]+1
names(df)
jerrs[18]<-length(sel)
df[sel,"improvement_surcharge"]<-NA 
sel
```

### 18. Tip_amount
```{r}
summary(df$Tip_amount)

# Outlier detection
Boxplot(df$Tip_amount)
var_out<-calcQ(df$Tip_amount)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")
abline(h=25,col="blue",lwd=2)

llout<-which((df$Tip_amount<0)|(df$Tip_amount>25))
iouts[llout]<-iouts[llout]+1
names(df)
jouts[16]<-length(llout)
df[llout,"Tip_amount"]<-NA 
sel
```

### 19. Tolls_amount
```{r}
# TO DO BITCHES
```


### 20. Total_amount
```{r}
summary(df$Total_amount)
# negative values seem to be errors - 0 Total_amount is possible when Payment_type =="No charge"

llsel<-rownames(df[which(df[,"Total_amount"]<0),])
# there are not "no charge", so they are also "errors"
# It is a quantitive variable  Non-possible values will be recoded to NA
sel<-which(df$Total_amount<0)
if (length(sel)>0) {
  ierrs[sel]<-ierrs[sel]+1
  jerrs[19]<-length(sel)
}
sel                 #### sel contains the rownames of the individuals with "0" 
#                        as  value for longitude
df[sel,"Total_amount"]<-NA    # non-possible values are replaced by NA, missing value symbol in R

# Outlier detection
Boxplot(df$Total_amount)
var_out<-calcQ(df$Total_amount)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")
abline(h=120,col="blue",lwd=2)

llout<-which((df$Total_amount<0)|(df$Total_amount>120))
iouts[llout]<-iouts[llout]+1
jouts[19]<-length(llout)
df[llout,"Total_amount"]<-NA 
```

### 21. Trip_type
```{r}
df$Trip_type<-factor(df$Trip_type,labels=c("Street-Hail","Dispatch"))
barplot(summary(df$Trip_type),main="Trip_type Barplot",col = "DarkOrchid")
# With the "factor" command what we are doing is factorizing the variable we pass to it and the value that comes out with the "levels" is the total number of our 5000 observations that each type of Trip_type has and as we can see all the factors have value and we have no NA (data missing)
```



## Exploratory Data Analysis for each variables (numeric summary and graphic support).
```{r}

```




### 17. Ehail_fee
```{r}
summary(df$Ehail_fee)
# WE DON’T TAKE IT INTO ACCOUNT BECAUSE IT’S NA
```


--------------------------------------------------------------------------------
# Initialization of counts for missings, outliers and errors. 
All numerical variables have to be checked before
```{r}

#######################################################
imis<-rep(0,nrow(df))  # rows - trips
jmis<-rep(0,2*ncol(df))  # columns - variables
######################################################
mis1<-countNA(df)
imis<-mis1$mis_ind
mis1$mis_col # Number of missings for the current set of variables

#######################################################
iouts<-rep(0,nrow(df))  # rows - trips
jouts<-rep(0,2*ncol(df))  # columns - variables
######################################################

#######################################################
ierrs<-rep(0,nrow(df))  # rows - trips
jerrs<-rep(0,2*ncol(df))  # columns - variables
######################################################


```
